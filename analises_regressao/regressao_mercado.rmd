---
title: "regressao_mercado"
output:
  pdf_document: default
---

```{r leitura_dados, include=FALSE}
setwd("C:/Users/gustavo.telles/Desktop/Multivariate-Statistics/csv")
library(tidyverse)
library(readxl)
dados <- read_xlsx("Aula 01.xlsx", sheet = "Exemplo1")
library(RColorBrewer)
library(knitr)
library(car)
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
options(scipen = 9999) #para retirar a nOtação científica
```

Regressão Linear Múltipla (RLM) 

OBJETIVO: Verificar quais fatores afetam o VOLUME de transações no mercado. Os possíveis fatores são 
IPCA, taxa de JUROS, POUPança, PIB, e EMBI+.

A base de dados Aula 01.xlsx (planilha Exemplo 1) contém as seguintes informações:
- VOLUME de transações no mercado
- IPCA (índice Nacional de Preços ao Consumidor Amplo)
- taxa de JUROS
- POUPança
- PIB
- EMBI+

Neste caso, temos:

variável dependente (y): VOLUME

variáveis independentes (x1, x2, x3, x4, x5): IPCA, JUROS, POUP, PIB, EMBI


Na RLM, a forma geral de uma equação é:

$$
y=b_0+b_1x_1+b_2x_2+...+b_kx_k
$$

```{r}
ggplot(dados, aes(x = IPCA, y = VOLUME)) +
  geom_point(color = "pink") +
  labs(title = "Relação entre VOLUME e IPCA", x = "IPCA", y = "VOLUME") +
  geom_smooth(method = "lm", se = FALSE, color = "black")

```

```{r}
ggplot(dados, aes(x = JUROS, y = VOLUME)) +
  geom_point(color = "blue") +
  labs(title = "Relação entre VOLUME e JUROS", x = "JUROS", y = "VOLUME") +
  geom_smooth(method = "lm", se = FALSE, color = "black")

```

```{r}
ggplot(dados, aes(x = PIB, y = VOLUME)) +
  geom_point(color = "purple") +
  labs(title = "Relação entre VOLUME e PIB", x = "PIB", y = "VOLUME") +
  geom_smooth(method = "lm", se = FALSE, color = "black")

```

```{r}
ggplot(dados, aes(x = POUP, y = VOLUME)) +
  geom_point(color = "brown") +
  labs(title = "Relação entre VOLUME e POUP", x = "POUP", y = "VOLUME") +
  geom_smooth(method = "lm", se = FALSE, color = "black")

```


```{r}
ggplot(dados, aes(x = EMBI, y = VOLUME)) +
  geom_point(color = "gold") +
  labs(title = "Relação entre VOLUME e EMBI", x = "EMBI", y = "VOLUME") +
  geom_smooth(method = "lm", se = FALSE, color = "black")

```

Observando os 5 gráficos, notamos um comportamento bem semelhante em que: quanto maior a variação de cada um dos índices de um mês para outro, menor tende a ser a variação do volume de transações do mercado. Ainda, essa associação entre volume e esses índices parece ser fraca, pois há bastante variabilidade ao redor da linha de tendência.

```{r correlacao, echo=FALSE}
tab_correl <- round(cor(dados[, 2:7]), 2)
kable(tab_correl, caption = "Matriz de correlações")
```

uma virgula com espaço vazio, para indicar qie vai usar todas as linhas


Inicialmente, observando as correlações de cada uma das variáveis independentes com o volume de transações, temos que de fato as associações são fracas e inversamente proporcionais conforme observamos nos gráficos. Ainda, entre elas, a taxa de juros é a que possui uma associação mais "forte".


Multicolinearidade

Na RLM, não pode haver alta correlação entre as variáveis independentes (x´s).Pela matriz de correlação, podemos observar algumas correlações moderadas a altas entre elas, o que pode indicar problema de multicolinearidade.

Para verificar se há a multicolinearidade, deve-se ajustar diversos modelos de regressão linear múltipla tratando cada variável independente como "dependente" e as demais x's como independentes para obter o R²(% da variabilidade da variável "dependente" que é explicada pelas variáveis independentes). Com esse R², calcula-se uma quantidade VIF (Variance Inflation Factor):

$$
VIF = 1/ (1-R^2)
$$
Notem que:

R², teríamos VIF=1 (não há multicolinearidade)

R²=0,8, teríamos VIF=5 (há multicolinearidade)

R²=0,90, teríamos VIF=10 (há multicolinearidade alta)

Portanto, utilizaremos VIF>5 como indicativo de multicolinearidade.


```{r multicolinearidade1, echo=FALSE}
modelo1 <- lm(VOLUME ~ IPCA + JUROS + PIB + POUP + EMBI, data = dados)
multicolinearidade1 <- round(vif(modelo1), 2)
kable(multicolinearidade1, caption = "VIF do Modelo1")
```


Pela tabela de VIF´s, temos duas variáveis apresentando problema de multicolinearidade (JUROS e POUP), então inicialmente devemos retirar APENAS UMA delas, pois pode ser que o problema já seja resolvido com essa retirada.

Como decidir qual será retirada inicialmente?

Vamos eliminar do modelo aquela que estiver associação mais fraca com a variável dependente (VOLUME).

Portanto, vamos retirar POUP que apresenta correlação de -0,14 com VOLUME.


```{r multicolinearidade2, echo=FALSE}
modelo2 <- lm(VOLUME ~ IPCA + JUROS + PIB + EMBI, data = dados)
multicolinearidade2 <- round(vif(modelo2), 2)
kable(multicolinearidade2, caption = "VIF do Modelo2")
```

Com a retirada de POUP do modelo, o problema de multicolinearidade foi resolvido. Portanto, podemos passar para a próxima etapa de teste de hipóteses.



TESTE DE HIPÓTESES GLOBAL

Inicialmente, testaremos se:

$H_0:$ modelo NÃO é útil (todas as variáveis independentes não tem relação com o volume de transações)

$H_a$: o modelo é útil (pelo menos 1 das variáveis independentes tem relação com o volume de transações)

```{r global, echo=FALSE}
summary(modelo2)
```


O valor-p deste teste aparece na última linha da saída (p-value = 0.03422) que é um valor menor que 0,10 (10% de significância) e rejeitamos H0. Logo, com 90% de confiança, o modelo é útil.

Como o modelo é útil, é necessário realizar os testes de hipóteses individuais para saber quantas e quais são as variáveis independentes que são individualmente (marginalmente) relacionadas com o volume de transações.

TESTES DE HIPÓTESES INDIVIDUAIS


Teremos que realizar 4 testes de hipóteses:

$H_0: b_i=0$ (não tem relação linear entre volume de transaçoes e xi)

$H_a: b_i\neq0$ (tem relação linear entre volume de transaçoes e xi)

$i=1,2,3,4$ (representando IPCA, JUROS, PIB e EMBI)


```{r}
resumo <- summary(modelo2) # o número do modelo vai ser o mesmo que utilizou para o teste de hipóteses anterior # nolint
tabela4 <- round(resumo$coefficients, 3) # guarda os coeficientes apenas com três casas decimais # nolint
tabela5 <- round(confint(modelo2, level = 0.90), 3) # guarda o LI e LS com 90% de confiança para os coeficientes apenas com três casas decimais # nolint
kable(tabela4, caption = "Estimativa dos coeficientes e teste de hipóteses")
kable(tabela5, caption = "Intervalo de confiança dos coeficientes")
```


Como os valores-p de IPCA e PIB são superiores a 10%, não rejeitamos H0 para essas variáveis. Isso significa que, com 90% de confiança, essas duas variáveis não estão marginalmente/individualmente relacionadas com o volume de transações. PORÉM, pode ser que CONJUNTAMENTE com as demais essas duas variáveis tenham uma contribuição importante no modelo. Para verificar isso, será necessário realizar um método de seleção de variáveis.

Método de seleção de Variavel


```{r}
library(MASS) # ativa o pacote necessário para a seleção de variáveis
stepAIC(modelo2, direction="backward") # o número do modelo vai ser o mesmo que utilizou para o teste de hipóteses anterior # nolint

```

Realizando o método de seleção de variáveis, realmente foi necessária a exclusão de PIB e IPCA. Portanto, o modelo final seria da forma:

$$
VOLUME=b_0+b_1JUROS+b_2EMBI
$$
```{r Final, echo=FALSE}
modelo3 <- lm(VOLUME ~ JUROS + EMBI, data = dados)

resumo <- summary(modelo3)

tabela6 <- round(resumo$coefficients, 3)
tabela7 <- round(confint(modelo3, level = 0.90), 3)

kable(tabela6, caption = "Coeficientes e teste de hipóteses do modelo final")
kable(tabela7, caption = "Intervalo de confiança dos coeficientes do modelo final") # nolint
```


Agora, precisamos testar o intercepto:

$H_0:b_0=0$ 

$H_a:b_0\neq 0$

Como valor-p (do intercepto) = 0,025 e o $\alpha=0,10$, REJEITAMOS $H_0$. Logo, não é necessário zerar o intercepto.


Interpretação dos coeficientes 

A equação estimada é:

$$
VOLUME=0,030-0,254JUROS-0,182EMBI
$$

Intepretação:

0,030: variação esperada (aumento esperado em relação ao mês anterior, neste caso) do volume de transações do mercado quando taxa de juros e EMBI não variarem em relação ao mês anterior (ou seja, quando forem iguais a ZERO), podendo variar entre 0,008 (0,8%) e 0,051 (5,1%) com 90% de confiança

-0,254*0,01: redução esperada no volume de transações do mercado em relação ao mês anterior quando a taxa de juros aumenta 1% (0,01) em relação ao mês anterior, mantendo EMBI constante (ceteris paribus), podendo variar entre -0,082*0,01 e -0,426*0,01, com 90% de confiança

-0,182*0,01: redução esperada no volume de transações do mercado em relação ao mês anterior quando o EMBI aumenta 1% (0,01) em relação ao mês anterior, mantendo taxa de juros constante (ceteris paribus), podendo variar entre -0,008*0,01 e -0,355*0,01, com 90% de confiança

R² ajustado

Para entender quanto da variação do volume de transações do mercado está sendo explicado pelo modelo final com JUROS e EMBI, vamos avaliar o R² ajustado:


```{r rquadrado, echo=FALSE}
cat("O valor do R-quadrado ajustado é:", round(resumo$adj.r.squared * 100, 2), "%\n") # nolint
```


Então, chegamos à conclusão que o modelo obtido não é adequado para realizar previsões do volume de transações do mercado já que JUROS e EMBI só conseguem explicar 3,79% da variabilidade do volume de transações.
